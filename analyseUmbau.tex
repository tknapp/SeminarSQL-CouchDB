\section{Analyse des Wechsels der Datenbank von MySQL zu CouchDB}
\label{analyse}

In diesem Kapitel wird der Wechsel von MySQL zu CouchDB konzeptionell betrachtet. Zunächst wird die Machbarkeit in Abschnitt \ref{machbarkeit} überprüft und anschließend ein Vorschlag zum Wechsel der Datenbanken in Abschnitt \ref{hybrid} gemacht.


\subsection{Grundsätzliche Machbarkeit des Wechsels}
\label{machbarkeit}

Bevor ein Wechsel von einem Datenbanksystem zu einem anderen beschlossen wird, sollte die Machbarkeit des Vorhabens geprüft werden. Im Falle von Olio sind die Ziele, welche durch einen Wechsel erreícht werden sollen, ein Performanzgewinn bei der Abfrage von Ereignissen durch viele Nutzer und höhere Flexibilität bei veränderten Anforderungen an beispielsweise Ereignisse oder Nutzer.\\
Wichtigste Voraussetzung für einen Wechsel ist, dass die alte Funktionalität der Anwendung erhalten bleibt. Zwar kann beispielsweise bei wenig genutzten Funktionen, die nicht mit dem neuen System realisiert werden können, abgewogen werden, ob sie zu Gunsten der Performanz des Gesamtsystems abgeschaltet werden könnten, jedoch sollte dies gut überlegt werden. Eventuell könnte eine Abschaltung zu Nutzerverlusten führen, da diese schneller wahrgenommen wird als ein Performanzgewinn.\\
Die Überprüfung der Machbarkeit des Wechsels muss für jede einzelne Funktionalität im Zusammenhang mit einer Datenbank überprüft werden. Für Olio bedeutet dies, dass zunächst alle datenbankrelevanten Funktionen gesammelt werden müssen und es muss geprüft werden, ob der Entwurf eines entsprechenden Views möglich ist. Nach der Untersuchung von Olio konnten die folgenden Funktionen gefunden werden:


\begin{itemize}
	\item[$\bullet$] Nutzer anlegen
	\item[$\bullet$] Login
	\item[$\bullet$] Ereignisse anlegen
	\item[$\bullet$] Ereignisse ansehen
	\item[$\bullet$] Bestimmtes Ereignis ansehen (Details)
	\item[$\bullet$] Durchsuchen der angezeigten Ereignisse nach Postleitzahl	     
  \item[$\bullet$] Sortieren der Ereignisse nach
  		\begin{itemize}
       \item[-] dem Erstellungsdatum
       \item[-] dem Ereignisdatum
     \end{itemize}
  \item[$\bullet$] Durchsuchen der den Ereignissen zugeordneten Stichworte nach Freitext
  \item[$\bullet$] Literatur zu einem Ereigniss anzeigen
  \item[$\bullet$] Teilnehmer ansehen
  \item[$\bullet$] Kommentieren von Ereignissen
  \item[$\bullet$] Kommentare ansehen
  \item[$\bullet$] Nutzer zu Ereignis einladen
\end{itemize}

Eine genauere Überprüfung muss nur bei abfragenden Funktionen durchgeführt werden, da schreibende Zugriffe auf die Datenbank wegen des schemalosen Designs von CouchDB problemlos möglich sind. Zu den reinen schreibenden Zugriffen zählen hier allerdings nur das Anlegen eines Nutzers und eines Ereignisses, sowie das Schreiben eines Kommentars zu einem Ereignis.\\
Die Funktionen zum Sortieren der Ereignisse nach Erstellungsdatum und dem Datum, an dem das Ereignis stattfindet, sind keine eindeutigen Datenbankzugriffe. Es gäbe einerseits die Möglichkeit, eine Sortierfunktion auf bereits aus der Datenbank geladenen Ereignissen zu erstellen, andererseits sind auch Views mit den verschiedenen Daten als Schlüssel vorstellbar. Gleiches gilt für die Suchfunktion nach Postleitzahl und nach Stichwort. Im Endeffekt bleibt es hier dem verantwortlichen Entwickler überlassen, auf welche Weise diese Funktionen implementiert werden. An dieser Stelle kann mangels empirischer Werte keine Empfehlung auf Basis der zu erwartenden Performanz für das eine oder das andere Verfahren gegeben werden.\\
Die restlichen Funktionen stellen jedoch eindeutige Datenbankzugriffe dar. Zum Überprüfen der Login-Daten kann ein View mit dem Benutzernamen als Schlüssel und dem Passwort als Wert verwendet werden. Sollen beispielsweise auf der Startseite der Anwendung alle Ereignisse bis zu einem bestimmten Datum angezeigt werden, so ist hierfür ein View mit den Daten der Ereignisse als Schlüssel und den restlichen Attributen des Ereignisses in Form eines Arrays als Wert denkbar. Für die Darstellung auf der Übersichtsseite ist allerdings nur der Zeitstempel, der Name und ein Miniaturbild notwendig. Prinzipiell wären die restlichen Attributwerte im Array dann zwar überflüssig, jedoch können diese für die Detaildarstellung eines Attributs verwendet werden.\\
Das Anzeigen der Literatur zu einem Ereignis und die Details einzelner Teilnehmer können als View implementiert werden. Werden als Schlüssel für den Zugriff auf die Literatur die Literatur selbst und zusätzlich das Ereignis zusammengefasst in einem Array verwendet, kann diese gut identifiziert werden. Unter der Annahme, dass jeder Nutzername individuell ist, kann bei der Suche nach einem bestimmten Nutzer der Nutzername als Schlüssel im View verwendet werden. \\
Eine Einladung eines Nutzers an einen anderen Nutzer zu einem Ereignis stellt eine Mischform aus lesenden und schreibenden Zugriffen auf die Datenbank dar, da im relationalen Modell in Olio eine eigene Tabelle für die Einladungen existiert, jedoch die Daten über beide beteiligten Nutzer und das Ereignis ebenfalls verfügbar sein müssen. Ähnlich verhält es sich mit Kommentaren, da für diese auch eine eigene Tabelle in Olio existiert. Hier weiß beispielsweise zwar ein Kommentar, dass er zu einem bestimmten Ereignis gehört, jedoch hat ein Ereignis selbst keinerlei Kenntnisse über dessen Existenz. Der gleiche Sachverhalt stellt sich bei Nutzern dar, die an einem Ereignis teilnehmen. Auch diese Information wird nicht mit einer Assoziation vom Ereignis zum Teilnehmer gespeichert.\\
Nach der konzeptionellen Einzelüberprüfung aller Funktionen von Olio kann resümiert werden, dass es grundsätzlich möglich ist, für alle Fälle einen entsprechenden View zu erstellen.\\

\subsection{Entwurfsentscheidungen zur Implementierung von CouchDB}
\label{hybrid}

Vor der endgültigen Umstellung von MySQL auf CouchDB müssen noch einige Design-Entscheidungen getroffen werden. Als Folge des schemalosen Designs von CouchDB sind keine Joins, wie sie aus SQL bekannt sind, möglich. Da es Teil des SQL-Konzeptes ist, dass Daten nicht redundant gespeichert werden, sondern über Fremdschlüsselbeziehungen miteinander verbunden werden und somit alle Daten auf mehrere Tabellen verteilt sind, muss hier bei der Implementierung von CouchDB-Views umgedacht werden. Zwar ist es in CouchDB grundsätzlich möglich, mit Views Fremdschlüsselbeziehungen zu implementieren, jedoch sollte dies nur sparsam eingesetzt werden. Dies wäre beispielsweise möglich, indem der eindeutige Schlüssel eines Dokumentes als Attribut in einem anderen Dokument gespeichert wird. Ein View, der als Schlüssel alle Dokumenten-IDs hat könnte so jeweils das richtige Dokument finden und es müsste lediglich auf das gewünschte Attribut zugegriffen werden. Bei dieser Vorgehensweise sind allerdings mehrere Anfragen an Views nötig, um eine vollständige Anfrage durchführen zu können, was auf Kosten der Performanz geht. CouchDB verfolgt statt Fremdschlüsseln das Konzept, Daten lieber redundant in mehreren Dokumenten zu speichern und somit alle Informationen mit dem Zugriff auf ein Dokument parat zu haben. Nur so kann der volle Performanzvorteil von CouchDB gegenüber einer relationalen Datenbank ausgenutzt werden. Dies bedeutet allerdings auch, dass die Dokumente, in denen die Daten aus den verschiedenen Tabellen der MySQL-Datenbank gespeichert werden sollen, entsprechend gut geplant werden müssen, damit auch alle Daten vorhanden sind. Faktisch heißt dies, dass jede Fremdschlüsselbeziehung überprüft werden muss, ob es Sinn macht, diese durch redundante Speicherung aufzulösen. Da der Umfang dieser Arbeit begrenzt ist, werden die Überlegungen an zwei Beispielen demonstriert.\\

Als erstes Beispiel soll überprüft werden, ob es sinnvoll ist, die Daten zu Nutzern jeweils immer dort zu speichern, wo sie benötigt werden. Der aktuelle Stand in Olio ist, dass es eine eigene Tabelle \textit{Users} (siehe Anhang) gibt, die von den Tabellen \textit{Comments}, \textit{Events}, \textit{Events-users} und \textit{Invites} referenziert wird. Dies bedeutet, dass alle 14 Attribute aus \textit{Users} (bzw. 13 ohne \textit{id}) in die vier genannten Tabellen mit übernommen werden müssten. Zwar könnte an der ein oder anderen Stelle reduziert werden, da eventuell nicht für alle Funktionen alle Nutzerattribute benötigt werden, jedoch ist dies zunächst anzunehmen. Außerdem ist zu beachten, dass \textit{Users} auch selbst zwei Fremdschlüssel verwendet (\textit{address\_id} und \textit{image\_id}), die möglicherweise auch aufgelöst werden müssen, wodurch sich die Anzahl der zu übernehmenden Attribute weiter erhöht. Folglich ist zu vermuten, dass eine vierfach-redundante Speicherung bei vielen Nutzern ein Aufwand wäre, der den daraus unter Umständen zu erwartenden Performanzgewinn nicht rechtfertigt. Die Fremdschlüsselbeziehungen sollten auch in CouchDB erhalten bleiben.\\

Ein zweites Beispiel betrifft die Tabelle \textit{Comments}, die zur Speicherung von Kommentaren zu bestimmten Ereignissen genutzt wird. Diese Tabelle verwendet momentan in Olio zwei Fremdschlüssel. \textit{user\_id} stellt eine Verbindung zum Nutzer her, der den Kommentar geschrieben hat, und \textit{event\_id} zeigt das Ereignis an, welches kommentiert wurde. Weder ein Ereignis noch ein Nutzer weiß direkt, welche Kommentare mit ihm verbunden sind.\\
Um bei dem Anzeigen eines Ereignisses nicht viele einzelne Abfragen bezüglich der Kommentare machen zu müssen, wäre die Überlegung in diesem Fall, die Tablle \textit{Comments} aufzulösen und dem jeweiligen Ereignis die Kommentare direkt zuzuordnen. In dem Ereignis-Dokument selbst könnte dies über ein JSON-Array realisiert werden, der jeweils die Kommentare und die dazugehörigen Nutzer speichert. Zwar bleibt dann immer noch der Fremdschlüssel zu \textit{Users}, jedoch ist mit der Eingliederung der Kommentare in das Ereignis-Dokument schon etwas Performanz gewonnen, ohne Redundanz zu verursachen, da ein Kommentar nur genau einem Ereignis zugeordnet wird. Da ein Kommentar lediglich sechs Attribute besitzt (abgesehen von \textit{id}, Vgl. siehe Anhang), wäre dieser Eingliederungsschritt sinnvoll.


\subsection{Ein hybrides Datenbanksystem}

Eine bisher bei der Betrachtung der Performanz vernachlässigter Faktor ist der Aufbau der Views. Selbst bei einer vergleichbar kleinen Überprüfung in einem View wie in Abbildung \ref{fig:MapFktUndView} gezeigt, kann es bei Datenbanken mit mehreren Millionen Dokumenten unter Umständen sehr lange Dauern, bis ein View aufgebaut ist. Zwar werden durch inkrementelle Replikation nur die Daten bei der Aktualisierung eines Views angeschaut, die auch verändert/hingezügt/gelöscht wurden, jedoch kann dieser Aufwand immer noch sehr hoch sein.\\
Da Olio nun aber eine agile Anwendung ist, die durch das Einstellen neuer Ereignisse, dem Schreiben von Kommentaren und dem Hinzukommen neuer Nutzer ständiger Veränderung unterliegt, sind lange Rechenzeiten zum Erstellen der Views nicht praktikabel. Denn damit auf ein Ereignis direkt nach der Veröffentlichung zugegriffen werden kann oder damit ein Kommentar sofort gelesen werden kann, müsste auch nach jeder Veränderung der entsprechende View neu geladen werden. Dies würde bei häufigen Zugriffen auf die Seite den eigentlich Performanz-Vorteil von CouchDB in ein Performanz-Nachteil umkehren, da ständig lesende Zugriffe blockiert würden. Grundsätzlich bedeutet diese Erkenntnis, dass CouchDB zur Speicherung der Daten von CouchDB nicht verwendet werden kann. Zumindest nicht allein.\\

Angelehnt an den Erfahrungsbericht eines Unternehmens (\cite{fromSQLToCouchDB}) wurde in dieser Arbeit die Idee entwickelt, CouchDB und MySQL gleichzeitig in Olio zu verwenden. Da CouchDB eher für beständigere Daten verwendet werden kann und MySQL einen sofortigen Zugriff auf gespeicherte Daten ermöglicht ist die Idee, eine CouchDB für ältere Daten einzusetzen und MySQL für "`frische"' Daten. \\
