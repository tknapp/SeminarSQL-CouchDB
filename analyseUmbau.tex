\section{Analyse des Wechsels der Datenbank von MySQL zu CouchDB}
\label{analyse}

In diesem Kapitel wird der Wechsel von MySQL zu CouchDB konzeptionell betrachtet. Zunächst wird die Machbarkeit in Abschnitt \ref{machbarkeit} überprüft und anschließend ein Vorschlag zum Wechsel der Datenbanken in Abschnitt \ref{hybrid} gemacht.


\subsection{Grundsätzliche Machbarkeit des Wechsels}
\label{machbarkeit}

Bevor ein Wechsel von einem Datenbanksystem zu einem anderen beschlossen wird, sollte die Machbarkeit des Vorhabens geprüft werden. Im Falle von Olio sind die Ziele, welche durch einen Wechsel erreícht werden sollen, ein Performanzgewinn bei der Abfrage von Ereignissen durch viele Nutzer und höhere Flexibilität bei veränderten Anforderungen an beispielsweise Ereignisse oder Nutzer.\\
Wichtigste Voraussetzung für einen Wechsel ist, dass die alte Funktionalität der Anwendung erhalten bleibt. Zwar kann beispielsweise bei wenig genutzten Funktionen, die nicht mit dem neuen System realisiert werden können, abgewogen werden, ob sie zu Gunsten der Performanz des Gesamtsystems abgeschaltet werden könnten, jedoch sollte dies gut überlegt werden. Eventuell könnte eine Abschaltung zu Nutzerverlusten führen, da diese schneller wahrgenommen wird als ein Performanzgewinn.\\
Die Überprüfung der Machbarkeit des Wechsels muss für jede einzelne Funktionalität im Zusammenhang mit einer Datenbank überprüft werden. Für Olio bedeutet dies, dass zunächst alle datenbankrelevanten Funktionen gesammelt werden müssen und es muss geprüft werden, ob der Entwurf eines entsprechenden Views möglich ist. Nach der Untersuchung von Olio konnten die folgenden Funktionen gefunden werden:


\begin{itemize}
	\item[$\bullet$] Nutzer anlegen
	\item[$\bullet$] Login
	\item[$\bullet$] Ereignisse anlegen
	\item[$\bullet$] Ereignisse ansehen
	\item[$\bullet$] Bestimmtes Ereignis ansehen (Details)
	\item[$\bullet$] Durchsuchen der angezeigten Ereignisse nach Postleitzahl	     
  \item[$\bullet$] Sortieren der Ereignisse nach
  		\begin{itemize}
       \item[-] dem Erstellungsdatum
       \item[-] dem Ereignisdatum
     \end{itemize}
  \item[$\bullet$] Durchsuchen der den Ereignissen zugeordneten Stichworte nach Freitext
  \item[$\bullet$] Literatur zu einem Ereigniss anzeigen
  \item[$\bullet$] Teilnehmer ansehen
  \item[$\bullet$] Kommentieren von Ereignissen
  \item[$\bullet$] Kommentare ansehen
  \item[$\bullet$] Nutzer zu Ereignis einladen
\end{itemize}

Eine genauere Überprüfung muss nur bei abfragenden Funktionen durchgeführt werden, da schreibende Zugriffe auf die Datenbank wegen des schemalosen Designs von CouchDB problemlos möglich sind. Zu den reinen schreibenden Zugriffen zählen hier allerdings nur das Anlegen eines Nutzers und eines Ereignisses, sowie das Schreiben eines Kommentars zu einem Ereignis.\\
Die Funktionen zum Sortieren der Ereignisse nach Erstellungsdatum und dem Datum, an dem das Ereignis stattfindet, sind keine eindeutigen Datenbankzugriffe. Es gäbe einerseits die Möglichkeit, eine Sortierfunktion auf bereits aus der Datenbank geladenen Ereignissen zu erstellen, andererseits sind auch Views mit den verschiedenen Daten als Schlüssel vorstellbar. Gleiches gilt für die Suchfunktion nach Postleitzahl und nach Stichwort. Im Endeffekt bleibt es hier dem verantwortlichen Entwickler überlassen, auf welche Weise diese Funktionen implementiert werden. An dieser Stelle kann mangels empirischer Werte keine Empfehlung auf Basis der zu erwartenden Performanz für das eine oder das andere Verfahren gegeben werden.\\
Die restlichen Funktionen stellen jedoch eindeutige Datenbankzugriffe dar. Zum Überprüfen der Login-Daten kann ein View mit dem Benutzernamen als Schlüssel und dem Passwort als Wert verwendet werden. Sollen beispielsweise auf der Startseite der Anwendung alle Ereignisse bis zu einem bestimmten Datum angezeigt werden, so ist hierfür ein View mit den Daten der Ereignisse als Schlüssel und den restlichen Attributen des Ereignisses in Form eines Arrays als Wert denkbar. Für die Darstellung auf der Übersichtsseite ist allerdings nur der Zeitstempel, der Name und ein Miniaturbild notwendig. Prinzipiell wären die restlichen Attributwerte im Array dann zwar überflüssig, jedoch können diese für die Detaildarstellung eines Attributs verwendet werden.\\
Das Anzeigen der Literatur zu einem Ereignis und die Details einzelner Teilnehmer können als View implementiert werden. Werden als Schlüssel für den Zugriff auf die Literatur die Literatur selbst und zusätzlich das Ereignis zusammengefasst in einem Array verwendet, kann diese gut identifiziert werden. Unter der Annahme, dass jeder Nutzername individuell ist, kann bei der Suche nach einem bestimmten Nutzer der Nutzername als Schlüssel im View verwendet werden. \\
Eine Einladung eines Nutzers an einen anderen Nutzer zu einem Ereignis stellt eine Mischform aus lesenden und schreibenden Zugriffen auf die Datenbank dar, da im relationalen Modell in Olio eine eigene Tabelle für die Einladungen existiert, jedoch die Daten über beide beteiligten Nutzer und das Ereignis ebenfalls verfügbar sein müssen. Ähnlich verhält es sich mit Kommentaren, da für diese auch eine eigene Tabelle in Olio existiert. Hier weiß beispielsweise zwar ein Kommentar, dass er zu einem bestimmten Ereignis gehört, jedoch hat ein Ereignis selbst keinerlei Kenntnisse über dessen Existenz. Der gleiche Sachverhalt stellt sich bei Nutzern dar, die an einem Ereignis teilnehmen. Auch diese Information wird nicht mit einer Assoziation vom Ereignis zum Teilnehmer gespeichert.\\
Nach der konzeptionellen Einzelüberprüfung aller Funktionen von Olio kann resümiert werden, dass es grundsätzlich möglich ist, für alle Fälle einen entsprechenden View zu erstellen.\\

\subsection{Entwurfsentscheidungen zur Implementierung von CouchDB}
\label{hybrid}

Vor der endgültigen Umstellung von MySQL auf CouchDB müssen noch einige Design-Entscheidungen getroffen werden. Als Folge des schemalosen Designs von CouchDB sind keine Joins, wie sie aus SQL bekannt sind, möglich. Da es Teil des SQL-Konzeptes ist, dass Daten nicht redundant gespeichert werden, sondern über Fremdschlüsselbeziehungen miteinander verbunden werden und somit alle Daten auf mehrere Tabellen verteilt sind, muss hier bei der Implementierung von CouchDB-Views umgedacht werden. Zwar ist es in CouchDB grundsätzlich möglich, mit Views Fremdschlüsselbeziehungen zu implementieren, jedoch sollte dies nur sparsam eingesetzt werden. Dies wäre beispielsweise möglich, indem der eindeutige Schlüssel eines Dokumentes als Attribut in einem anderen Dokument gespeichert wird. Ein View, der als Schlüssel alle Dokumenten-IDs hat könnte so jeweils das richtige Dokument finden und es müsste lediglich auf das gewünschte Attribut zugegriffen werden. Bei dieser Vorgehensweise sind allerdings mehrere Anfragen an Views nötig, um eine vollständige Anfrage durchführen zu können, was auf Kosten der Performanz geht. CouchDB verfolgt statt Fremdschlüsseln das Konzept, Daten lieber redundant in mehreren Dokumenten zu speichern und somit alle Informationen mit dem Zugriff auf ein Dokument parat zu haben. Nur so kann der volle Performanzvorteil von CouchDB gegenüber einer relationalen Datenbank ausgenutzt werden. Dies bedeutet allerdings auch, dass die Dokumente, in denen die Daten aus den verschiedenen Tabellen der MySQL-Datenbank gespeichert werden sollen, entsprechend gut geplant werden müssen, damit auch alle Daten vorhanden sind. Faktisch heißt dies, dass jede Fremdschlüsselbeziehung überprüft werden muss, ob es Sinn macht, diese durch redundante Speicherung aufzulösen. Da der Umfang dieser Arbeit begrenzt ist, werden die Überlegungen an zwei Beispielen demonstriert.\\

Als erstes Beispiel soll überprüft werden, ob es sinnvoll ist, die Daten zu Nutzern jeweils immer dort zu speichern, wo sie benötigt werden. Der aktuelle Stand in Olio ist, dass es eine eigene Tabelle \textit{Users} (siehe Anhang) gibt, die von den Tabellen \textit{Comments}, \textit{Events}, \textit{Events-users} und \textit{Invites} referenziert wird. Dies bedeutet, dass alle 14 Attribute aus \textit{Users} (bzw. 13 ohne \textit{id}) in die vier genannten Tabellen mit übernommen werden müssten. Zwar könnte an der ein oder anderen Stelle reduziert werden, da eventuell nicht für alle Funktionen alle Nutzerattribute benötigt werden, jedoch ist dies zunächst anzunehmen. Außerdem ist zu beachten, dass \textit{Users} auch selbst zwei Fremdschlüssel verwendet (\textit{address\_id} und \textit{image\_id}), die möglicherweise auch aufgelöst werden müssen, wodurch sich die Anzahl der zu übernehmenden Attribute weiter erhöht. Folglich ist zu vermuten, dass eine vierfach-redundante Speicherung bei vielen Nutzern ein Aufwand wäre, der den daraus unter Umständen zu erwartenden Performanzgewinn nicht rechtfertigt. Die Fremdschlüsselbeziehungen sollten auch in CouchDB erhalten bleiben.\\

Ein zweites Beispiel betrifft die Tabelle \textit{Comments}, die zur Speicherung von Kommentaren zu bestimmten Ereignissen genutzt wird. Diese Tabelle verwendet momentan in Olio zwei Fremdschlüssel. \textit{user\_id} stellt eine Verbindung zum Nutzer her, der den Kommentar geschrieben hat, und \textit{event\_id} zeigt das Ereignis an, welches kommentiert wurde. Weder ein Ereignis noch ein Nutzer weiß direkt, welche Kommentare mit ihm verbunden sind.\\
Um bei dem Anzeigen eines Ereignisses nicht viele einzelne Abfragen bezüglich der Kommentare machen zu müssen, wäre die Überlegung in diesem Fall, die Tablle \textit{Comments} aufzulösen und dem jeweiligen Ereignis die Kommentare direkt zuzuordnen. In dem Ereignis-Dokument selbst könnte dies über ein JSON-Array realisiert werden, der jeweils die Kommentare und die dazugehörigen Nutzer speichert. Zwar bleibt dann immer noch der Fremdschlüssel zu \textit{Users}, jedoch ist mit der Eingliederung der Kommentare in das Ereignis-Dokument schon etwas Performanz gewonnen, ohne Redundanz zu verursachen, da ein Kommentar nur genau einem Ereignis zugeordnet wird. Da ein Kommentar lediglich sechs Attribute besitzt (abgesehen von \textit{id}, Vgl. siehe Anhang), wäre dieser Eingliederungsschritt sinnvoll.


\subsection{Ein hybrides Datenbanksystem}

Ein bisher bei der Betrachtung der Performanz vernachlässigter Faktor ist der Aufbau der Views. Selbst bei einer vergleichbar kleinen Überprüfung in einem View wie in Abbildung \ref{fig:MapFktUndView} gezeigt, kann es bei Datenbanken mit mehreren Millionen Dokumenten unter Umständen sehr lange Dauern, bis ein View aufgebaut ist. Zwar werden durch die inkrementelle Replikation nur die Daten bei einer Aktualisierung eines Views angeschaut, die auch verändert, hingezügt oder gelöscht wurden, jedoch kann dieser Aufwand immer noch sehr hoch sein.\\
Da Olio nun aber eine agile Anwendung ist, die durch das Einstellen neuer Ereignisse, dem Schreiben von Kommentaren und dem Hinzukommen neuer Nutzer ständiger Veränderung unterliegt, sind lange Rechenzeiten zum Erstellen der Views nicht akzeptabel. Denn damit auf ein Ereignis direkt nach der Veröffentlichung zugegriffen werden kann oder damit ein Kommentar sofort gelesen werden kann, müsste auch nach jeder Veränderung der entsprechende View neu geladen werden. Dies würde bei häufigen Zugriffen auf die Seite den eigentlich Performanz-Vorteil von CouchDB in ein Performanz-Nachteil umkehren, da ständig lesende Zugriffe blockiert würden. Grundsätzlich bedeutet diese Erkenntnis, dass CouchDB zur Speicherung der Daten von CouchDB nicht verwendet werden kann. Zumindest nicht allein.\\

Angelehnt an einen Erfahrungsbericht (\cite{fromSQLToCouchDB}) wird in dieser Arbeit die Idee beschrieben, CouchDB und MySQL gleichzeitig in Olio zu verwenden. Da CouchDB eher für beständigere Daten verwendet werden kann und MySQL einen sofortigen Zugriff auf gespeicherte Daten ermöglicht, ist die Idee, eine CouchDB für ältere Daten einzusetzen und MySQL für "`frische"' Daten zu verwenden. \\
Im Fall von Olio werden als "`frische"' Daten die Daten eines Tages angesehen. Das heißt, dass alle hinzugefügten Ereignisse, Nutzer, Kommentare etc. zunächst in einer MySQL-Datenbank abgespeichert werden, aus der sie auch wieder direkt ausgelesen werden können. Daten, die älter als einen Tag sind, werden in der Couch-Datenbank gehalten. Diese Aufteilung basiert auf der Annahme, dass die Menge der alten Daten deutlich größer als die der tagesaktuellen Daten ist. Für den Zugriff auf diese große Datenmenge können Views verwendet werden, wodurch die Performanzvorteile von CouchDB ausgenutzt werden. Auf die nun kompakte MySQL-Datenbank im Vergleich zum Gesamtdatenbestand wird weiterhin mit normalen SQL-Anfragen zugegriffen, die bei geringen Datenmengen als ausreichend performant angesehen werden \textcolor{red}{[QUELLE!]}. Die tagesaktuellen Daten könnten beispielsweise jede Nacht, wenn weniger Anfragen an das System gestellt werden, in die Couch-Datenbank übertragen werden. So könnten die Views nur einmal täglich neu gebaut werden, ohne eine übermäßige Beeinträchtigung der Web-Anwendung zu verursachen. Nach einer Übertragung ist die MySQL-Datenbank leer und bereit für neue Daten. Natürlich könnten die Übertragungsintervalle auch nur wenige Stunden oder auch mehrere Tage betragen, jedoch müsste dies erst in der Praxis getestet werden.\\
Auf den ersten Blick scheint diese Datenbankkombination nur auf die Manipulation tagesaktueller Daten ausgelegt zu sein. Es ist jedoch durchaus möglich, auch Daten zu verändern, die schon in der Couch-Datenbank abgelegt wurden.

\begin{figure}
	\centering
		\includegraphics[width=1.00\textwidth]{figures/Mapping.png}
	\caption{Beispieländerung an einem bestehenden Dokument in CouchDB (verkürzte Darstellung)}
	\label{fig:Mapping}
\end{figure}

In Abbildung \ref{fig:Mapping} ist auf der rechten Seite ein JSON-Dokument für ein Ereignis mit dem Titel "`Stadtfest"' in verkürzter Form dargestellt. Dieses Ereignis wurde bereits von einem Nutzer "`user1"' kommentiert. Ein weiterer Nutzer "`user2"' schaut sich dieses Ereignis an und möchte ebenfalls einen Kommentar abgeben. Da dieser Kommentar allerdings auch direkt angezeigt werden soll, würde es nicht ausreichen, ihn in dem JSON-Dokument abzuspeichern, da er erst in den View geladen werden müsste. Auch ist es nicht möglich, ein Dokument in CouchDB zu verändern, sondern es werden die Daten des Dokuments ausgelesen, verändert, in ein neues Dokument gespeichert und das alte gelöscht. \\
Speichert "`user2"' nun seinen Kommentar ab, wird in der MySQL-Datenbank ein neues Ereignis mit der ID des kommentierten Ereignisses erzeugt. Auch wird ein neuer Kommentar in der Tabelle "`Comments"' erzeugt, der auf den Nutzer und das Ereignis referenziert. Attribute, die sich nicht verändert haben, wie in diesem Beispiel der Titel (\textit{title}) und die Beschreibung (\textit{description}), erhalten als Wert einen leeren String.\\
Werden nun die MySQL-Datenbank und die Couch-Datenbank synchronisiert, wird für jedes Ereignis zunächst in der Couch-Datenbank nach einem Ereignis mit passender ID gesucht. Existiert zu einem Ereignis in der MySQL-Datenbank bereits ein Ereignis in der Couch-Datenbank, wird ein neues Dokument erstellt, welches zunächst die alten, unveränderten Daten aus der Couch-Datenbank übernimmt (alle Felder, die in der MySQL-Datenbank "`"' sind). Alle veränderten Attribute werden mit dem Inhalt der MySQL-DB überschrieben. Der neu hinzugefügte Kommentar wird als neues Element im Array \textit{comments} des JSON-Dokuments angelegt. Dieser ist in Abbildung \ref{fig:Mapping} rot dargestellt. Soll auch das Löschen oder Verändern von Kommentaren ermöglicht werden, müsste die ID jeden Kommentars mit im JSON-Dokument abgelegt werden.\\

Wurde ein Ereignis vor mehr als einem Tag erstellt und später manipuliert, liegen die aktuellen Werte der Attribute des Ereignisses am Tag der Manipulation in zwei verschiedenen Datenbanken. Fragt ein Nutzer dieses Ereignis ab, reicht es nicht aus, das CouchDB-Dokument darzustellen, sondern es muss vorher überprüft werden, ob zu diesem Ereignis Aktualisierungen in der MySQL-DB vorliegen. Hierzu wird wie beim Synchronisierungsprozess die ID des Ereignisses in beiden Datenbanken gesucht und jeweils die aktuellsten Attribute ausgelesen. Da es sich um zwei getrennte Datenbanken handelt, kann der Suchvorgang parallel ablaufen, wodurch sich die Suchzeiten nicht addieren und keine Performanznachteile entstehen.\\

Das in Kapitel \ref{olio} beschriebene ActiveRecord kann nicht zum Anschluss von CouchDB an Olio verwendet werden. In den letzten Jahren wurden allerdings schon verschiedene Bibliotheken entwickelt, die dies ermöglichen. Hier steht beispielsweise \textit{CouchRest} \cite{couchRest} oder ActiveCouch \cite{activeCouch} zur Verfügung. Welche Bibliothek im Endeffekt verwendet wird, hängt vom verantwortlichen Programmierer ab und kann an dieser Stelle nicht entschieden werden.\\
Grundsätzlich kann der Abschluss von zwei Datenbank so realisiert werden, dass in den Rails-\textit{Models} eine Proxy-Klasse eingeführt wird, die bei jeder Anfrage entscheidet, welche Datenbank abgefragt werden muss. Falls notwendig ist diese Klasse auch für das Zusammensetzen der Informationen zu einem Ereignis aus den beiden Datenbanken zuständig. So kann verhindert werden, dass die Rails-Views vollständig auf ein neues Datenformat umgestellt werden müssen, da die Ausgaben von CouchDB und MySQL unterschiedlich sind. Die Proxy-Klasse bildet eine Art "`Middleware"', um die Ausgaben der verschiedenen Datenbanken für die Views zu homogenisieren.\\
Eine Aufgabe, die auch nach der erfolgreichen Umstellung der Datenbanken weiter beachtet werden sollte, ist die kontinuierliche Verbesserung der Views. Durch veränderte Anforderungen an die Web-Anwendung oder schlichtweg ungünstige Planung beim Erstellen der Views, können schnell eigentlich unnötige Datenmengen entstehen, die eigentlich nicht verwendet werden. Da Speicherplatz Geld kostet, egal ob er gekauft oder gemietet wird, muss aus betriebswirtschaftlicher Sicht eine ständige Optimierung der Views zur Optimierung des Speicherbedarfs durchgeführt werden.